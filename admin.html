<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>لوحة إدارة البورتفوليو</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap">
<style>
:root{--bg:#0f172a;--card:#0b1320;--card2:#1e293b;--text:#e2e8f0;--muted:#94a3b8;--accent:#06b6d4}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:'Inter',sans-serif}
.wrap{max-width:960px;margin:auto;padding:24px}
.card{background:var(--card2);border:1px solid #334155;border-radius:18px;margin:16px 0;padding:16px}
h1,h2,h3{margin:0 0 10px;color:var(--accent)}
small{color:var(--muted)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
label{display:block;margin:8px 0 6px}
input,select,textarea{width:100%;padding:10px;background:#0b1320;color:var(--text);border:1px solid #334155;border-radius:10px}
textarea{min-height:90px}
.btn{display:inline-block;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff}
.btn.muted{background:#334155;color:#fff}
.btn.danger{background:#dc2626;color:#fff}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.badge{display:inline-block;background:#0b1320;border:1px solid #334155;border-radius:999px;padding:4px 10px;font-size:12px;margin-inline-start:8px}
.list{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.item{background:#0b1320;border:1px solid #334155;border-radius:12px;overflow:hidden}
.item img{width:100%;height:150px;object-fit:cover;display:block}
.item .meta{padding:8px 10px;color:var(--muted);font-size:13px;min-height:36px}
.item .actions{display:flex;gap:6px;padding:10px}
.note{font-size:13px;color:var(--muted)}
.pin{display:flex;gap:10px;align-items:center}
</style>
</head>
<body>
<div class="wrap">
  <h1>لوحة إدارة البورتفوليو</h1>

  <!-- PIN بسيط -->
  <div class="card">
    <h3>أمان بسيط</h3>
    <div class="pin">
      <input id="pin" type="password" placeholder="أدخل PIN بسيط (مثلاً 2025)">
      <button class="btn primary" onclick="login()">دخول</button>
      <small class="note">حماية شكلية محلية فقط.</small>
    </div>
  </div>

  <div id="app" style="display:none">
    <!-- إضافة عنصر -->
    <div class="card">
      <h2>إضافة عنصر <span id="quota" class="badge">الحجم: —</span></h2>

      <div class="grid-2">
        <div>
          <label>القسم</label>
          <select id="section">
            <option value="designs">أعمال التصميم الإعلاني</option>
            <option value="campaigns">أداء الحملات الإعلانية</option>
            <option value="certs">الدورات والشهادات</option>
          </select>
        </div>
        <div>
          <label>روابط صور (اختياري — سطر لكل رابط)</label>
          <textarea id="imgUrl" placeholder="https://example.com/1.jpg
https://example.com/2.jpg"></textarea>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>رفع صور من جهازك (يدعم تحديد عدة صور)</label>
          <input id="imgFile" type="file" accept="image/*" multiple>
          <small class="note">نضغط الصور تلقائيًا (WebP، أقصى عرض 1280px).</small>
        </div>
        <div>
          <label>رابط خارجي (اختياري — للشهادات مثلاً)</label>
          <input id="linkUrl" type="url" placeholder="https://...">
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>وصف قصير (اختياري)</label>
          <input id="caption" type="text" placeholder="وصف مختصر">
        </div>
        <div>
          <label>معاينة أول ملف</label>
          <img id="preview" style="width:100%;height:150px;object-fit:cover;border-radius:10px;border:1px solid #334155" alt="">
        </div>
      </div>

      <div class="row">
        <button class="btn primary" onclick="addItem()">إضافة</button>
        <small id="msg" class="note"></small>
      </div>
    </div>

    <!-- إضافة قسم جديد -->
    <div class="card">
      <h2>إضافة قسم جديد</h2>
      <div class="grid-2">
        <div>
          <label>اسم القسم (مثال: أعمال الفيديو، أعمال الطباعة…)</label>
          <input id="newSectionName" type="text" placeholder="اسم القسم">
        </div>
        <div class="row" style="align-items:end">
          <button class="btn primary" onclick="addSection()">إضافة القسم</button>
          <small class="note">سيظهر القسم فورًا في القوائم.</small>
        </div>
      </div>
    </div>

    <!-- القائمة -->
    <div class="card">
      <h2>القائمة الحالية</h2>
      <div class="row" style="margin:6px 0 12px">
        <label>اختر القسم</label>
        <select id="viewSection" onchange="renderList()">
          <option value="designs">أعمال التصميم الإعلاني</option>
          <option value="campaigns">أداء الحملات الإعلانية</option>
          <option value="certs">الدورات والشهادات</option>
        </select>
      </div>
      <div id="list" class="list"></div>
    </div>

    <!-- نسخ احتياطي -->
    <div class="card">
      <h2>نسخ احتياطي</h2>
      <div class="grid-2">
        <div>
          <label>تصدير البيانات</label>
          <div class="row">
            <button class="btn muted" onclick="exportData()">تنزيل JSON (نسخة عامة)</button>
            <button class="btn muted" onclick="exportDataJson()">تنزيل data.json (للنشر)</button>
          </div>
        </div>
        <div>
          <label>استيراد البيانات (JSON)</label>
          <div class="row">
            <input id="importFile" type="file" accept="application/json">
            <button class="btn primary" onclick="importData()">استيراد</button>
          </div>
        </div>
      </div>
      <hr style="border:0;border-top:1px solid #334155;margin:14px 0">
      <button class="btn danger" onclick="resetData()">حذف كل البيانات المحلية</button>
      <small class="note">لا يحذف صور الإنترنت—يمسح LocalStorage فقط.</small>
    </div>
  </div>
</div>

<script>
/* === مفاتيح التخزين === */
const KEY='als_portfolio_v1';
const PIN_KEY='als_pin_ok';

/* === تسجيل دخول بسيط === */
function login(){
  const pin=document.getElementById('pin').value.trim();
  if(!pin){ alert('أدخل PIN'); return; }
  localStorage.setItem(PIN_KEY,'1');
  document.getElementById('app').style.display='block';
  updateQuota();
}

window.addEventListener('load',()=>{
  if(localStorage.getItem(PIN_KEY)==='1'){ document.getElementById('app').style.display='block'; }
  ensureData();
  syncSectionOptions(getData());
  renderList();
  updateQuota();
});

/* معاينة أول ملف */
document.getElementById('imgFile').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const url=await fileToDataURL(f,1280,0.82).catch(()=>null);
  if(url) document.getElementById('preview').src=url;
});

/* === بنية البيانات (مع ترحيل القديم) === */
function ensureData(){
  if(!localStorage.getItem(KEY)){
    const empty={sections:{designs:[],campaigns:[],certs:[]}};
    localStorage.setItem(KEY,JSON.stringify(empty)); return;
  }
  try{
    const raw=JSON.parse(localStorage.getItem(KEY));
    if(!raw.sections){
      const migrated={sections:{designs:raw.designs||[],campaigns:raw.campaigns||[],certs:raw.certs||[]}};
      localStorage.setItem(KEY,JSON.stringify(migrated));
    }
  }catch(e){
    const empty={sections:{designs:[],campaigns:[],certs:[]}};
    localStorage.setItem(KEY,JSON.stringify(empty));
  }
}
function getData(){ ensureData(); try{return JSON.parse(localStorage.getItem(KEY));}catch(e){return {sections:{designs:[],campaigns:[],certs:[]}}} }
function setData(d){ localStorage.setItem(KEY,JSON.stringify(d)); updateQuota(); }

/* === مساحة التقريب === */
function approxBytesUsed(){ try{const s=localStorage.getItem(KEY)||''; return new Blob([s]).size;}catch(e){return 0;} }
function formatBytes(b){ if(b<1024)return b+' B'; if(b<1024*1024)return (b/1024).toFixed(1)+' KB'; return (b/1024/1024).toFixed(2)+' MB'; }
function updateQuota(){ const el=document.getElementById('quota'); if(!el) return; const used=approxBytesUsed(); el.textContent='الحجم: '+formatBytes(used)+' (حد المتصفح ~5–10MB)'; if(used>4.5*1024*1024){ el.style.background='#7c2d12'; el.title='قارب الامتلاء—خفّض الصور أو استخدم استضافة خارجية'; }}

/* === إضافة عناصر (روابط + ملفات متعددة) === */
async function addItem(){
  const section=document.getElementById('section').value;
  const linkUrl=document.getElementById('linkUrl').value.trim();
  const caption=document.getElementById('caption').value.trim();
  const files=Array.from(document.getElementById('imgFile').files||[]);
  const urlText=document.getElementById('imgUrl').value.trim();
  const urlList=urlText?urlText.split('\n').map(s=>s.trim()).filter(Boolean):[];
  const data=getData();
  if(!data.sections[section]) data.sections[section]=[];
  let added=0;

  // روابط
  for(const u of urlList){
    data.sections[section].push({img:u, ...(linkUrl?{link:linkUrl}:{}) , ...(caption?{caption}:{})});
    added++;
  }

  // ملفات
  for(const file of files){
    try{
      let dataUrl=await fileToDataURL(file,1280,0.82);
      if(sizeOfDataURL(dataUrl)>700*1024){ dataUrl=await fileToDataURL(file,1080,0.78); }
      data.sections[section].push({img:dataUrl, ...(linkUrl?{link:linkUrl}:{}) , ...(caption?{caption}:{})});
      added++;
    }catch(e){ console.warn('تعذّر تحويل', file?.name||''); }
  }

  setData(data);
  // تنظيف
  document.getElementById('imgUrl').value='';
  document.getElementById('linkUrl').value='';
  document.getElementById('caption').value='';
  document.getElementById('imgFile').value='';
  document.getElementById('preview').src='';
  document.getElementById('msg').textContent=added?('تمت إضافة '+added+' عنصرًا.'):'لم تتم إضافة عناصر.';
  renderList();
}

/* === الأقسام === */
function addSection(){
  const name=document.getElementById('newSectionName').value.trim();
  if(!name) return alert('اكتب اسم القسم.');
  const data=getData();
  const key=name.toLowerCase().replace(/\s+/g,'_');
  if(data.sections[key]) return alert('هذا القسم موجود مسبقًا.');
  data.sections[key]=[];
  setData(data);
  addOptionIfMissing(document.getElementById('section'),key,name);
  addOptionIfMissing(document.getElementById('viewSection'),key,name);
  document.getElementById('newSectionName').value='';
  alert('تمت إضافة القسم.');
  renderList();
}
function addOptionIfMissing(selectEl,value,label){
  if(Array.from(selectEl.options).some(o=>o.value===value)) return;
  const opt=document.createElement('option'); opt.value=value; opt.textContent=label; selectEl.appendChild(opt);
}
function syncSectionOptions(data){
  const namesMap={designs:'أعمال التصميم الإعلاني',campaigns:'أداء الحملات الإعلانية',certs:'الدورات والشهادات'};
  const s1=document.getElementById('section'), s2=document.getElementById('viewSection');
  Object.keys(data.sections).forEach(k=>{
    const label=namesMap[k]||k.replace(/_/g,' ');
    addOptionIfMissing(s1,k,label); addOptionIfMissing(s2,k,label);
  });
}

/* === عرض القائمة / إدارة العناصر === */
function renderList(){
  const section=document.getElementById('viewSection').value;
  const data=getData();
  const list=document.getElementById('list'); list.innerHTML='';
  const arr=(data.sections&&data.sections[section])?data.sections[section]:[];
  arr.forEach((it,idx)=>{
    const card=document.createElement('div'); card.className='item';
    card.innerHTML=`
      ${it.link?`<a href="${it.link}" target="_blank">`:``}
      <img src="${it.img}" alt="">
      ${it.link?`</a>`:``}
      <div class="meta">${it.caption??''}</div>
      <div class="actions">
        <button class="btn muted" onclick="moveItem('${section}',${idx},-1)">↑</button>
        <button class="btn muted" onclick="moveItem('${section}',${idx},1)">↓</button>
        <button class="btn danger" onclick="deleteItem('${section}',${idx})">حذف</button>
      </div>`;
    list.appendChild(card);
  });
  syncSectionOptions(data);
}
function moveItem(section,idx,dir){
  const data=getData(); const arr=data.sections[section];
  const n=idx+dir; if(n<0||n>=arr.length) return;
  [arr[idx],arr[n]]=[arr[n],arr[idx]]; setData(data); renderList();
}
function deleteItem(section,idx){
  const data=getData(); data.sections[section].splice(idx,1); setData(data); renderList();
}

/* === نسخ احتياطي === */
function exportData(){
  const data=getData();
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='als_portfolio_backup.json'; a.click();
}
function exportDataJson(){
  const data=getData();
  const payload=data.sections?data:{sections:{designs:data.designs||[],campaigns:data.campaigns||[],certs:data.certs||[]}};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='data.json'; a.click();
}
function importData(){
  const f=document.getElementById('importFile').files[0]; if(!f) return alert('اختر ملف JSON');
  const r=new FileReader();
  r.onload=()=>{ try{
      const loaded=JSON.parse(r.result);
      if(!(loaded.sections&&typeof loaded.sections==='object')) throw Error('schema');
      setData(loaded); renderList(); updateQuota(); alert('تم الاستيراد.');
    }catch(e){ alert('ملف غير صالح.'); } };
  r.readAsText(f);
}
function resetData(){
  if(confirm('متأكد من حذف كل البيانات المحلية؟')){ localStorage.removeItem(KEY); ensureData(); renderList(); updateQuota(); }
}

/* === أدوات الصور === */
function sizeOfDataURL(dataUrl){ const i=dataUrl.indexOf('base64,'); if(i===-1) return 0; const b64=dataUrl.slice(i+7); return Math.floor(b64.length*3/4); }
function loadImage(file){ return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=URL.createObjectURL(file); }); }
async function fileToDataURL(file,maxW=1280,quality=0.82){
  const img=await loadImage(file); const c=document.createElement('canvas'), ctx=c.getContext('2d');
  const ratio=img.width/img.height; const w=Math.min(maxW,img.width); const h=Math.round(w/ratio);
  c.width=w; c.height=h; ctx.drawImage(img,0,0,w,h);
  return c.toDataURL('image/webp',quality);
}
</script>
</body>
</html>
